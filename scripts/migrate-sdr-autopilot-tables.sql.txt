-- Migration Script: Add SDR Autopilot Tables
-- Run this script to add tables for SmartCRM SDR Autopilot functionality
-- Execute in Supabase SQL Editor or via migration tool

-- Create agent_threads table for storing OpenAI thread references
CREATE TABLE IF NOT EXISTS agent_threads (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    lead_id TEXT NOT NULL,
    thread_id TEXT NOT NULL UNIQUE,
    agent_type TEXT NOT NULL DEFAULT 'sdr_autopilot',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create autopilot_state table for storing SDR campaign state
CREATE TABLE IF NOT EXISTS autopilot_state (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    lead_id TEXT NOT NULL,
    agent_type TEXT NOT NULL DEFAULT 'sdr_autopilot',
    state_json JSONB NOT NULL DEFAULT '{}',
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'paused', 'stopped', 'completed')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_agent_threads_lead_id ON agent_threads(lead_id);
CREATE INDEX IF NOT EXISTS idx_agent_threads_agent_type ON agent_threads(agent_type);
CREATE INDEX IF NOT EXISTS idx_agent_threads_thread_id ON agent_threads(thread_id);

CREATE INDEX IF NOT EXISTS idx_autopilot_state_lead_id ON autopilot_state(lead_id);
CREATE INDEX IF NOT EXISTS idx_autopilot_state_agent_type ON autopilot_state(agent_type);
CREATE INDEX IF NOT EXISTS idx_autopilot_state_status ON autopilot_state(status);

-- Add unique constraint to prevent duplicate autopilot states per lead
CREATE UNIQUE INDEX IF NOT EXISTS idx_autopilot_state_unique ON autopilot_state(lead_id, agent_type);

-- Add updated_at trigger function if it doesn't exist
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Add triggers for updated_at
CREATE TRIGGER update_agent_threads_updated_at
    BEFORE UPDATE ON agent_threads
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_autopilot_state_updated_at
    BEFORE UPDATE ON autopilot_state
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Add RLS (Row Level Security) policies
ALTER TABLE agent_threads ENABLE ROW LEVEL SECURITY;
ALTER TABLE autopilot_state ENABLE ROW LEVEL SECURITY;

-- Allow users to access their own leads' agent threads
CREATE POLICY "Users can access agent threads for their leads"
    ON agent_threads FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM contacts c
            WHERE c.id = agent_threads.lead_id
            AND c.created_by = auth.uid()::text
        )
    );

-- Allow users to access their own leads' autopilot state
CREATE POLICY "Users can access autopilot state for their leads"
    ON autopilot_state FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM contacts c
            WHERE c.id = autopilot_state.lead_id
            AND c.created_by = auth.uid()::text
        )
    );

-- Create migration log entry
INSERT INTO migration_log (migration_name, executed_at, description)
VALUES ('sdr-autopilot-tables', NOW(), 'Added agent_threads and autopilot_state tables for SDR Autopilot functionality');

-- Verification queries
DO $$
BEGIN
    RAISE NOTICE 'SDR Autopilot tables migration completed successfully!';
    RAISE NOTICE 'Created tables: agent_threads, autopilot_state';
    RAISE NOTICE 'Added indexes and RLS policies';
    RAISE NOTICE 'Migration logged in migration_log table';
END $$;

-- Optional: Create a view for easy SDR Autopilot monitoring
CREATE OR REPLACE VIEW sdr_autopilot_dashboard AS
SELECT
    a.lead_id,
    c.name as lead_name,
    c.email as lead_email,
    c.company,
    a.status as autopilot_status,
    a.state_json->>'current_step' as current_step,
    a.state_json->>'total_steps' as total_steps,
    a.state_json->>'last_action' as last_action,
    a.state_json->>'next_scheduled' as next_scheduled,
    a.created_at as autopilot_started,
    a.updated_at as last_updated,
    t.thread_id
FROM autopilot_state a
LEFT JOIN contacts c ON c.id = a.lead_id
LEFT JOIN agent_threads t ON t.lead_id = a.lead_id AND t.agent_type = 'sdr_autopilot'
WHERE a.agent_type = 'sdr_autopilot'
ORDER BY a.updated_at DESC;

-- Grant access to the view
GRANT SELECT ON sdr_autopilot_dashboard TO authenticated;